<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="keywords" content="">
  <meta name="description" content="">
  <title>grid</title>
  <link rel="stylesheet" type="text/css" href="css/gird.css">
  <style type="text/css">
    .demo-grid {
      width: 800px;
      margin: 50px auto;
    }
  </style>
</head>
<body>
<div class="demo-grid">

  <div class="sc-grid-wrapper" style="width:600px;" id="grid-wrapper-1">
    <div class="sc-grid-table" style="width:300px;">
      <div class="sc-table-header-wrapper" style="overflow: hidden">
        <div class="sc-table-header" style="width: 300px;">
          <div class="sc-table-column" data-col-index="0" data-frozen="true" style="width: 100px"><span class="header-text">测试1</span></div>
          <div class="sc-table-column" data-col-index="1" data-frozen="true" style="width: 100px"><span class="header-text">测试2</span></div>
          <div class="sc-table-column" data-col-index="2" data-frozen="true" style="width: 100px"><span class="header-text">测试3</span></div>
        </div>
      </div>
      <div class="sc-table-wrapper" style="height:120px;overflow:hidden;padding-bottom:17px;">
        <table style="width: 300px;" cellpadding="0" cellspacing="0">
          <colgroup>
            <col style="width: 100px;"/>
          </colgroup>
          <colgroup>
            <col style="width: 100px;"/>
          </colgroup>
          <colgroup>
            <col style="width: 100px;"/>
          </colgroup>
          <tbody>
          <tr  data-rowIndex="0">
            <td>test</td>
            <td>abc</td>
            <td>ddd1</td>
          </tr>
          <tr  data-rowIndex="1">
            <td>test</td>
            <td>abc</td>
            <td>ddd2</td>
          </tr>
          <tr  data-rowIndex="2">
            <td>test</td>
            <td>abc</td>
            <td>ddd3</td>
          </tr>
          <tr data-rowIndex="3">
            <td>test</td>
            <td>abc</td>
            <td>ddd4</td>
          </tr>
          <tr data-rowIndex="4">
            <td>test</td>
            <td>abc</td>
            <td>ddd5</td>
          </tr>
          <tr data-rowIndex="5">
            <td>test</td>
            <td>abc</td>
            <td>ddd6</td>
          </tr>
          <tr data-rowIndex="6">
            <td>test</td>
            <td>abc</td>
            <td>ddd7</td>
          </tr>
          <tr data-rowIndex="7">
            <td>test</td>
            <td>abc</td>
            <td>ddd8</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="sc-grid-table" style="width:300px;">
      <div class="sc-table-header-wrapper" style="overflow: hidden">
        <div class="sc-table-header" style="width:617px;">
          <div class="sc-table-column" data-col-index="3" style="width: 100px"><span class="header-text">测试1</span></div>
          <div class="sc-table-column" data-col-index="4" style="width: 100px"><span class="header-text">测试2</span></div>
          <div class="sc-table-column" data-col-index="5" style="width: 100px"><span class="header-text">测试3</span></div>
          <div class="sc-table-column" data-col-index="6" style="width: 100px"><span class="header-text">测试1</span></div>
          <div class="sc-table-column" data-col-index="7" style="width: 100px"><span class="header-text">测试2</span></div>
          <div class="sc-table-column" data-col-index="8" style="width: 100px"><span class="header-text">测试3</span></div>
        </div>
      </div>
      <div class="sc-table-wrapper" style="height:120px;overflow: auto;">
        <table style="width: 600px;" cellpadding="0" cellspacing="0">
          <colgroup>
            <col style="width: 100px;"/>
          </colgroup>
          <colgroup>
            <col style="width: 100px;"/>
          </colgroup>
          <colgroup>
            <col style="width: 100px;"/>
          </colgroup>
          <colgroup>
            <col style="width: 100px;"/>
          </colgroup>
          <colgroup>
            <col style="width: 100px;"/>
          </colgroup>
          <colgroup>
            <col style="width: 100px;"/>
          </colgroup>
          <tbody>
          <tr data-rowIndex="0">
            <td>test</td>
            <td>abc</td>
            <td>dd2d</td>
            <td>test</td>
            <td>abc</td>
            <td>ddd</td>
          </tr>
          <tr data-rowIndex="1">
            <td>tes2t</td>
            <td>abc</td>
            <td>ddd</td>
            <td>test</td>
            <td>a2bc</td>
            <td>ddd</td>
          </tr>
          <tr data-rowIndex="2">
            <td>test</td>
            <td>abc</td>
            <td>d2dd</td>
            <td>test</td>
            <td>abc</td>
            <td>ddd</td>
          </tr>
          <tr data-rowIndex="3">
            <td>test</td>
            <td>ab2c</td>
            <td>ddd</td>
            <td>test</td>
            <td>abc</td>
            <td>ddd</td>
          </tr>
          <tr data-rowIndex="4">
            <td>test</td>
            <td>abc</td>
            <td>ddd</td>
            <td>test</td>
            <td>ab2c</td>
            <td>d3dd</td>
          </tr>
          <tr data-rowIndex="5">
            <td>tes4t</td>
            <td>abc</td>
            <td>ddd</td>
            <td>test</td>
            <td>abc</td>
            <td>d5dd</td>
          </tr>
          <tr data-rowIndex="6">
            <td>test</td>
            <td>a6bc</td>
            <td>ddd</td>
            <td>test</td>
            <td>abc</td>
            <td>ddd</td>
          </tr>
          <tr data-rowIndex="7">
            <td>test</td>
            <td>abc</td>
            <td>dd6d</td>
            <td>test</td>
            <td>ab6c</td>
            <td>ddd</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

</div>

<script type="text/javascript" src="js/lib/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/grid.js"></script>
<script type="text/javascript">

  var divDragMask = null;
  var $curDragTarget = null;
  var $cols = null;

  $(function () {
    $('.sc-table-wrapper').on('mousewheel scroll', function () {
      var $this = $(this);
      var $closestGridTable = $this.closest('.sc-grid-table');

      $closestGridTable.find('.sc-table-header-wrapper').scrollLeft($this.scrollLeft());
      $closestGridTable.siblings('.sc-grid-table').find('.sc-table-wrapper').scrollTop($this.scrollTop());
    });

    $('.sc-table-column').on({
      'mousedown': function (e) {
        var $this = $(this);
        var offsetX = $this.offset().left;
        var width = $this.width();

        if ((offsetX + width - e.pageX) >= 0 &&  (offsetX + width - e.pageX) < 5) {
          $curDragTarget = $this;

          createTableDragMask(e);
        }
      },
      'mouseenter mousemove': function (e) {
        var $this = $(this);
        var offsetX = $this.offset().left;
        var width = $this.width();

        if ((offsetX + width - e.pageX) >= 0 &&  (offsetX + width - e.pageX) < 5) {
          $this.css({
            'cursor': 'col-resize'
          });
        } else {
          $this.css({
            'cursor': 'default'
          });
        }
      }
    });

    $(document).on({
      'mouseup': function (e) {
        $curDragTarget = null;
      },
      'mousemove': function (e) {
        clearDocumentSelection();
      }
    });

    $cols = $('#grid-wrapper-1 colgroup');
  });

  function createTableDragMask(e) {
    var maskW = '300';
    var maskH = '300';
    var mousePosition = getEventPosition(e);
    var maskLeft = mousePosition.x - maskW / 2;
    var maskTop = mousePosition.y - maskH / 2;

    divDragMask = document.createElement('div');
    divDragMask.style.cssText = 'width:' + maskW + 'px;height:' + maskH + 'px;left:'+ maskLeft + 'px;top:' + maskTop + 'px;position:absolute;background:transparent;z-index:999999;';

    document.body.appendChild(divDragMask);

    $(divDragMask).on({
      'mousemove': resizeColumn,
      'mouseup': deleteTableDragMask
    });

    function resizeColumn(e) {
      var $this = $(this);
      var minColumnW = 20;
      var minTableW = 40;
      var colIndex = $curDragTarget.data('col-index');
      var maskPosition = getObjectPosition($this);
      var mousePosition = getEventPosition(e);
      var gapX = mousePosition.x - maskPosition.x - maskW / 2;
      var $curCol = $($cols[colIndex]).find('col');
      var $curTable = $curCol.closest('table');
      var $curTableHeader = $curDragTarget.closest('.sc-table-header');
      var $curGridTable = $curDragTarget.closest('.sc-grid-table');
      var $gridWrapper = $curDragTarget.closest('.sc-grid-wrapper');
      var gridWrapperW = $gridWrapper.width();
      var curColumnW = $curCol.width() + gapX;

      divDragMask.style.left = mousePosition.x - maskW / 2 + 'px';

      if (curColumnW > minColumnW && (gridWrapperW - ($curGridTable.width() + gapX) > minTableW)) {

        $curDragTarget[0].style.width = $curCol[0].style.width = curColumnW + 'px';

        $curTableHeader[0].style.width = $curTableHeader.width() + gapX + 'px';


        if ($curDragTarget.data('frozen') === true) {  // 移动冻结列
          $curTable[0].style.width = $curTableHeader.width() + 'px';
          $curGridTable.css({
            width: $curGridTable.width() + gapX + 'px'
          }).siblings('.sc-grid-table').css({
            width: gridWrapperW - $curGridTable.width() + 'px'
          });
        } else {
          $curTable[0].style.width = $curTableHeader.width() - 17 + 'px';
        }
      }
    }

    function checkResizeBound() {

    }
  }

  function clearDocumentSelection() {
    if (document.selection) {
      document.selection.empty ? document.selection.empty() : (document.selection = null);
    } else if (window.getSelection) {
      window.getSelection().removeAllRanges();
    }
  }

  function deleteTableDragMask() {
    divDragMask && document.body.removeChild(divDragMask);
  }

  function getObjectPosition($obj) {
    return {
      x: $obj.offset().left,
      y: $obj.offset().top
    };
  }

  function getEventPosition(e) {
    return {
      x: e.pageX,
      y: e.pageY
    };
  }
</script>
</body>
</html>
